AWSTemplateFormatVersion: '2010-09-09'
Description: Template for CloudFormation demo example
Parameters:
  IAMUser:
    Type: String
    Description: The ARN of the IAM user (e.g., arn:aws:iam::123123123123:user/myuid).
    Default: arn:aws:iam::344740472567:user/f.cellamare
  Email:
    Type: String
    AllowedPattern: ^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$
    ConstraintDescription: Must be a valid email address.
    Default: francesco.pio.cellamare28@gmail.com
  BranchName:
    Description: CodeCommit branch name
    Type: String
    Default: master
  RepositoryName:
    Description: CodeComit repository name
    Type: String
    Default: SpringProjectRepository
  ProjectName:
    Description: CodeBuild project name
    Type: String
    Default: DemoCodeBuildCloudFormation
  EventBusName:
    Description: Event bus name
    Type: String
    Default: DemoEventBusCloudFormation
  InstanceName:
    Description: EC2 instance name
    Type: String
    Default: DemoEC2CloudFormation
  InstanceTypeValue:
    Description: EC2 instance Type
    Type: String
    Default: t3.micro
    AllowedValues:
    - t3.micro
    ConstraintDescription: Must be a valid EC2 instance type
  VPCName:
    Description: VPC name
    Type: String
    Default: DemoVPCCloudFormation
  SubnetName:
    Description: Subnet name
    Type: String
    Default: DemoSubnetCloudFormation
  IgwName:
    Description: Internet Gateway name
    Type: String
    Default: DemoIgwCloudFormation
  RoutingTableName:
    Description: Routing table name
    Type: String
    Default: DemoRoutingTableCloudFormation
  PipelineName:
    Description: CodePipeline pipeline name
    Type: String
    Default: DemoPipeline
  BucketName:
    Description: Bucket name
    Type: String
    Default: demo-bucket-cloudformation
  MyIPAddress:
    Description: The IP address allowed to access SSH and HTTP ports (e.g., your IP)
    Type: String
    Default: 0.0.0.0/0
    AllowedPattern: (\d{1,3}\.){3}\d{1,3}/\d{1,2}
    ConstraintDescription: Must be a valid IP address with CIDR notation (e.g., x.x.x.x/32).
  ServiceName:
    Type: String
    Default: spring-boot-service
  ContainerPort:
    Type: Number
    Default: 8080
  ContainerCpu:
    Type: String
    Default: 128
  ContainerMemory:
    Type: String
    Default: 1GB
  HealthCheckPath:
    Type: String
    Default: /
  MinContainers:
    Type: Number
    Default: 1
Resources:
  EventRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - events.amazonaws.com
          Action: sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: eb-pipeline-execution
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action: codepipeline:StartPipelineExecution
            Resource:
              Fn::Join:
              - ''
              - - 'arn:aws:codepipeline:'
                - Ref: AWS::Region
                - ':'
                - Ref: AWS::AccountId
                - ':'
                - Ref: PipelineName
  EventRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Rule to filter out pull request
      EventPattern:
        source:
        - aws.codecommit
        detail-type:
        - CodeCommit Repository State Change
        resources:
        - Fn::Join:
          - ''
          - - 'arn:aws:codecommit:'
            - Ref: AWS::Region
            - ':'
            - Ref: AWS::AccountId
            - ':'
            - Ref: RepositoryName
        detail:
          event:
          - referenceCreated
          - referenceUpdated
          referenceType:
          - tag
          referenceName:
          - GENERATE
      Targets:
      - Arn:
          Fn::Join:
          - ''
          - - 'arn:aws:codepipeline:'
            - Ref: AWS::Region
            - ':'
            - Ref: AWS::AccountId
            - ':'
            - Ref: PipelineName
        RoleArn:
          Fn::GetAtt:
          - EventRole
          - Arn
        Id: codepipeline-PipelineName
  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: codepipeline.amazonaws.com
          Action:
          - sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AWSStepFunctionsConsoleFullAccess
      - arn:aws:iam::aws:policy/AWSStepFunctionsFullAccess
      - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceEventsRole
      - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceRole
      - arn:aws:iam::aws:policy/AmazonS3FullAccess
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
      - PolicyName: CodePipelinePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - iam:PassRole
            Resource: '*'
            Condition:
              StringEqualsIfExists:
                iam:PassedToService:
                - cloudformation.amazonaws.com
                - elasticbeanstalk.amazonaws.com
                - ec2.amazonaws.com
                - ecs-tasks.amazonaws.com
          - Effect: Allow
            Action:
            - codecommit:CancelUploadArchive
            - codecommit:GetBranch
            - codecommit:GetCommit
            - codecommit:GetRepository
            - codecommit:GetUploadArchiveStatus
            - codecommit:UploadArchive
            Resource: '*'
          - Effect: Allow
            Action:
            - codedeploy:CreateDeployment
            - codedeploy:GetApplication
            - codedeploy:GetApplicationRevision
            - codedeploy:GetDeployment
            - codedeploy:GetDeploymentConfig
            - codedeploy:RegisterApplicationRevision
            Resource: '*'
          - Effect: Allow
            Action:
            - codestar-connections:UseConnection
            Resource: '*'
          - Effect: Allow
            Action:
            - elasticbeanstalk:*
            - ec2:*
            - elasticloadbalancing:*
            - autoscaling:*
            - cloudwatch:*
            - s3:*
            - sns:*
            - cloudformation:*
            - rds:*
            - sqs:*
            - ecs:*
            Resource: '*'
          - Effect: Allow
            Action:
            - lambda:InvokeFunction
            - lambda:ListFunctions
            Resource: '*'
          - Effect: Allow
            Action:
            - opsworks:CreateDeployment
            - opsworks:DescribeApps
            - opsworks:DescribeCommands
            - opsworks:DescribeDeployments
            - opsworks:DescribeInstances
            - opsworks:DescribeStacks
            - opsworks:UpdateApp
            - opsworks:UpdateStack
            Resource: '*'
          - Effect: Allow
            Action:
            - cloudformation:CreateStack
            - cloudformation:DeleteStack
            - cloudformation:DescribeStacks
            - cloudformation:UpdateStack
            - cloudformation:CreateChangeSet
            - cloudformation:DeleteChangeSet
            - cloudformation:DescribeChangeSet
            - cloudformation:ExecuteChangeSet
            - cloudformation:SetStackPolicy
            - cloudformation:ValidateTemplate
            Resource: '*'
          - Effect: Allow
            Action:
            - codebuild:BatchGetBuilds
            - codebuild:StartBuild
            - codebuild:BatchGetBuildBatches
            - codebuild:StartBuildBatch
            Resource: '*'
          - Effect: Allow
            Action:
            - devicefarm:ListProjects
            - devicefarm:ListDevicePools
            - devicefarm:GetRun
            - devicefarm:GetUpload
            - devicefarm:CreateUpload
            - devicefarm:ScheduleRun
            Resource: '*'
          - Effect: Allow
            Action:
            - servicecatalog:ListProvisioningArtifacts
            - servicecatalog:CreateProvisioningArtifact
            - servicecatalog:DescribeProvisioningArtifact
            - servicecatalog:DeleteProvisioningArtifact
            - servicecatalog:UpdateProduct
            Resource: '*'
          - Effect: Allow
            Action:
            - cloudformation:ValidateTemplate
            Resource: '*'
          - Effect: Allow
            Action:
            - ecr:DescribeImages
            Resource: '*'
          - Effect: Allow
            Action:
            - states:DescribeExecution
            - states:DescribeStateMachine
            - states:StartExecution
            Resource: '*'
          - Effect: Allow
            Action:
            - appconfig:StartDeployment
            - appconfig:StopDeployment
            - appconfig:GetDeployment
            Resource: '*'
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: '*'
          - Effect: Allow
            Action:
            - codecommit:*
            Resource:
            - Fn::Sub: arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:${RepositoryName}
          - Effect: Allow
            Action:
            - s3:*
            Resource:
            - Fn::Sub: arn:aws:s3:::${BucketName}/*
            - '*'
          - Effect: Allow
            Action:
            - codebuild:*
            Resource: '*'
          - Effect: Allow
            Action:
            - codedeploy:*
            Resource: '*'
          - Effect: Allow
            Action:
            - ecs:*
            - ecr:*
            - elasticbeanstalk:*
            - elasticloadbalancing:*
            - ec2:*
            - sqs:*
            - opsworks:*
            - devicefarm:*
            - servicecatalog:*
            Resource: '*'
  PipelineInstance:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name:
        Ref: PipelineName
      RoleArn:
        Fn::GetAtt:
        - CodePipelineServiceRole
        - Arn
      ArtifactStore:
        Type: S3
        Location:
          Ref: ArtifactStoreBucket
      Stages:
      - Name: Source
        Actions:
        - Name: SourceAction
          ActionTypeId:
            Category: Source
            Owner: AWS
            Provider: CodeCommit
            Version: '1'
          OutputArtifacts:
          - Name: SourceOutput
          Configuration:
            OutputArtifactFormat: CODEBUILD_CLONE_REF
            RepositoryName:
              Ref: RepositoryName
            BranchName:
              Ref: BranchName
            PollForSourceChanges: false
          RunOrder: 1
      - Name: PreBuild
        Actions:
        - Name: PreBuildAction
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: '1'
          InputArtifacts:
          - Name: SourceOutput
          OutputArtifacts:
          - Name: DeployOutput
          Configuration:
            ProjectName:
              Ref: ProjectName
          RunOrder: 2
          Namespace: BuildVariables
      - Name: StateMachine
        Actions:
        - Name: FeedbackStateMachine
          ActionTypeId:
            Category: Invoke
            Owner: AWS
            Provider: StepFunctions
            Version: '1'
          Configuration:
            StateMachineArn:
              Fn::GetAtt:
              - FeedbackStateMachine
              - Arn
            Input:
              Fn::Sub: "{\n  \"bucketname\": \"${BucketName}\",\n  \"key\": \"${PipelineName}/DeployOutp/\"\
                ,\n  \"buildResult\": \"#{BuildVariables.BUILD_STATUS}\",\n  \"branch\"\
                : \"${BranchName}\"\n}\n"
          InputArtifacts:
          - Name: DeployOutput
          OutputArtifacts:
          - Name: MergedDeployOutput
          RunOrder: 3
      - Name: Deploy
        Actions:
        - Name: ECSDeployAction
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: ECS
            Version: '1'
          InputArtifacts:
          - Name: MergedDeployOutput
          Configuration:
            ClusterName: spring-boot-app
            ServiceName: backend-service
            FileName: output.json
          RunOrder: 4
  ArtifactStoreBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Ref: BucketName
      Tags:
      - Key: Name
        Value:
          Ref: BucketName
      AccessControl: Private
  ArtifactStoreBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: ArtifactStoreBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Sid: FullAccessForIAMUser
          Effect: Allow
          Action: s3:*
          Resource:
          - Fn::Sub: arn:aws:s3:::${BucketName}
          - Fn::Sub: arn:aws:s3:::${BucketName}/*
          Principal:
            AWS:
              Ref: IAMUser
  CodeBuildInstance:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        EncryptionDisabled: true
        OverrideArtifactName: true
        Type: CODEPIPELINE
      BadgeEnabled: false
      ConcurrentBuildLimit: '1'
      Description: Demo build stage inside the pipeline
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        Type: LINUX_CONTAINER
      Name:
        Ref: ProjectName
      QueuedTimeoutInMinutes: '5'
      ServiceRole:
        Fn::GetAtt:
        - CodeBuildServiceRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec:
          Fn::Sub: "version: 0.2\nenv:\n  shell: /bin/bash\n  exported-variables:\n\
            \    - BUILD_STATUS\n    \nphases:\n  install:\n    on-failure: ABORT\n\
            \    commands:\n      - echo \"Inline buildspec\"\n      - echo \"Setting\
            \ JAVA_HOME to Java 17\"\n      - export JAVA_HOME=$(dirname $(dirname\
            \ $(readlink -f $(which java))))\n      - echo $JAVA_HOME\n      - echo\
            \ \"Installing dependencies\"\n      - echo \"Checking Java version\"\n\
            \      - java -version\n      - mvn -v\n\n  pre_build:\n    on-failure:\
            \ ABORT\n    commands:\n      - echo \"Cleaning up previous artifacts...\"\
            \n      - aws s3 rm s3://${BucketName}/DemoPipeline/DeployOutp --recursive\n\
            \      - aws s3 rm s3://${BucketName}/DemoPipeline/ReportOutp --recursive\n\
            \      - aws s3 rm s3://${BucketName}/build-artifacts --recursive\n  \
            \    - echo \"Starting the build process\"\n      - mvn clean validate\
            \ -q\n\n  build:\n    on-failure: ABORT\n    commands:\n      - echo \"\
            Compiling the Spring Boot project\"\n      - mvn clean compile -q\n\n\
            \  post_build:\n    on-failure: CONTINUE\n    commands:\n      - echo\
            \ \"Running the test suite\"\n      - mvn test -q && export BUILD_STATUS=\"\
            SUCCEEDED\" || export BUILD_STATUS=\"FAILED\"\n      - echo \"Tests completed\"\
            \n      - echo \"Uploading Surefire reports to S3\"\n      - zip -r FeedbackBuildArtifacts.zip\
            \ target/surefire-reports/\n      - aws s3 cp FeedbackBuildArtifacts.zip\
            \ s3://${BucketName}/build-artifacts/\n      - echo \"Uploaded Surefire\
            \ reports\"\n      - git show --name-status HEAD > report.txt\n      -\
            \ cat report.txt\n      - echo \"Generated report\"\n      - echo \"Building\
            \ the Spring Boot project\"\n      - mvn clean package -q -DskipTests\n\
            \      - jdeps --recursive -verbose:class target/classes/ | grep -E \"\
            ^(\\s)*com\\.example.demo(.)*classes$\" | tr -s \" \" | rev | cut -d'\
            \ ' -f2- | rev > deps.txt\n      - aws s3 cp deps.txt s3://${BucketName}/deps/\n\
            \      - echo \"Ending\"\n\nartifacts:\n  files:\n    - '**/*'\n  name:\
            \ DeployOutput\n  secondary-artifacts:\n    ReportOutput:\n      files:\n\
            \        - report.txt\n      name: ReportOutput\n      discard-paths:\
            \ yes\n    DeployOutput:\n      files:\n        - target/*.jar\n     \
            \ name: DeployOutput\n      discard-paths: no\n"
      Tags:
      - Key: Name
        Value:
          Ref: ProjectName
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: codebuild.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AWSCodeCommitFullAccess
      - arn:aws:iam::aws:policy/AmazonS3FullAccess
      - arn:aws:iam::aws:policy/AWSCodeBuildAdminAccess
      Path: /
      Policies:
      - PolicyName: CodeBuildPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource:
            - Fn::Sub: arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:${RepositoryName}
            - '*'
  CodeBuildFeedbackInstance:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: S3
        Location:
          Ref: ArtifactStoreBucket
        Path: build-artifacts/
        Packaging: ZIP
        Name: FeedbackBuildArtifacts.zip
      ConcurrentBuildLimit: '1'
      Description: Build stage inside the state machine
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        Type: LINUX_CONTAINER
      Name: FeedbackBuildProject
      QueuedTimeoutInMinutes: '5'
      ServiceRole:
        Fn::GetAtt:
        - CodeBuildServiceRole
        - Arn
      Source:
        Type: CODECOMMIT
        Location:
          Fn::Sub: https://git-codecommit.${AWS::Region}.amazonaws.com/v1/repos/${RepositoryName}
        BuildSpec:
          Fn::Sub: "version: 0.2\nenv:\n  shell: /bin/bash\n\nphases:\n  install:\n\
            \    on-failure: CONTINUE\n    commands:\n      - echo \"Setting JAVA_HOME\
            \ to Java 17\"\n      - export JAVA_HOME=$(dirname $(dirname $(readlink\
            \ -f $(which java))))  # This sets JAVA_HOME\n      - echo $JAVA_HOME\n\
            \      - echo \"Installing dependencies\"\n      - echo \"Checking Java\
            \ version\"\n      - java -version\n      - mvn -v\n\n  pre_build:\n \
            \   on-failure: CONTINUE\n    commands:\n      - echo \"Starting the build\
            \ process\"\n      - mvn clean validate -q\n\n  build:\n    on-failure:\
            \ CONTINUE\n    commands:\n      - echo \"Compiling the Spring Boot project\"\
            \n      - mvn clean compile -q\n\n  post_build:\n    on-failure: CONTINUE\n\
            \    commands:\n      - echo \"Running the test suite\"\n      - mvn test\
            \ -q\n      - echo \"Tests completed\"\n      - echo \"End\"\nartifacts:\n\
            \  files:\n    - target/surefire-reports/**\n  discard-paths: yes \n"
      Tags:
      - Key: Name
        Value: FeedbackBuildProject
  CodeBuildFinalRevisionServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: sts:AssumeRole
          Principal:
            Service: codebuild.amazonaws.com
      Policies:
      - PolicyName: CodeBuildPermissions
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - ecr:*
            - codecommit:*
            - ecs:*
            - s3:*
            - logs:*
            Resource: '*'
  CodeBuildFinalRevision:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: S3
        Location:
          Ref: ArtifactStoreBucket
      ConcurrentBuildLimit: '1'
      Description: Pre deploy build stage
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        Type: LINUX_CONTAINER
      Name: FinalRevisionBuildProject
      QueuedTimeoutInMinutes: '5'
      ServiceRole:
        Fn::GetAtt:
        - CodeBuildFinalRevisionServiceRole
        - Arn
      Source:
        Type: CODECOMMIT
        Location:
          Fn::Sub: https://git-codecommit.${AWS::Region}.amazonaws.com/v1/repos/${RepositoryName}
        BuildSpec:
          Fn::Sub: "version: 0.2\n\nphases:\n  pre_build:\n    commands:\n      -\
            \ pwd\n      - docker --version\n      - ls\n      - echo Logging in to\
            \ Amazon ECR...\n      - aws --version\n      - aws ecr get-login-password\
            \ --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin\
            \ ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com\n      - REPOSITORY_URI=${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/spring-boot-app\n\
            \  build:\n    commands:\n      - echo Building the Docker image...\n\
            \      - docker build -t $REPOSITORY_URI:latest .\n      - docker tag\
            \ $REPOSITORY_URI:latest $REPOSITORY_URI:latest\n  post_build:\n    commands:\n\
            \      - echo Pushing the Docker images...\n      - docker push $REPOSITORY_URI:latest\n\
            \      - echo Writing image definitions file...\n      - echo \"[{\\\"\
            name\\\":\\\"spring-boot-app\\\",\\\"imageUri\\\":\\\"$REPOSITORY_URI:latest\\\
            \"}]\" > imagedefinitions.json\n      - echo \"imagedefinitions.json file\
            \ created.\"\nartifacts:\n  files:\n    - imagedefinitions.json\n"
      Tags:
      - Key: Name
        Value: FinalRevisionBuildProject
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LambdaRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      - arn:aws:iam::aws:policy/AmazonS3FullAccess
      - arn:aws:iam::aws:policy/AWSCloudFormationFullAccess
      - arn:aws:iam::aws:policy/AWSCodeCommitFullAccess
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      - arn:aws:iam::aws:policy/SecretsManagerReadWrite
  CreateReport:
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
      - x86_64
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/f5b22f0ac57340a2c2ea92a4fce2218e
      Description: State to create the report from the previus build phase, both commit
        one and tests execution one will be created
      FunctionName: createReport
      Handler: index.createReport
      Role:
        Fn::GetAtt:
        - LambdaRole
        - Arn
      Runtime: python3.10
      Timeout: 120
    DependsOn: LambdaRole
  CreatePullRequest:
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
      - x86_64
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/e272b45b429911d531bb0082e9672f2e
      Description: State to create the final pull request if everything succeeded
      FunctionName: createPullRequest
      Handler: index.createPullRequest
      Role:
        Fn::GetAtt:
        - LambdaRole
        - Arn
      Runtime: python3.10
      Timeout: 30
      Environment:
        Variables:
          REPOSITORY_NAME:
            Ref: RepositoryName
    DependsOn: LambdaRole
  CheckPullRequest:
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
      - x86_64
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/ba270079c9c0f0a927e8f5f48b10389f
      Description: State to check the final pull request if everything succeeded
      FunctionName: checkPullRequest
      Handler: index.checkPullRequest
      Role:
        Fn::GetAtt:
        - LambdaRole
        - Arn
      Runtime: python3.10
      Timeout: 400
      Environment:
        Variables:
          REPOSITORY_NAME:
            Ref: RepositoryName
    DependsOn: LambdaRole
  AdaptOutput:
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
      - x86_64
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/70e8946ed68af7493d6077e16f76220a
      Description: State to adapt the output to the input requirements of Amazon ECS
      FunctionName: adaptOutput
      Handler: index.adaptOutput
      Role:
        Fn::GetAtt:
        - LambdaRole
        - Arn
      Runtime: python3.10
      Timeout: 30
    DependsOn: LambdaRole
  HandleReport:
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
      - x86_64
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/58de209f9f50560df8002b67548f1a34
      Description: State to generate test suite for the given .class file
      FunctionName: handleReport
      Handler: index.handleReport
      Role:
        Fn::GetAtt:
        - LambdaRole
        - Arn
      Layers:
      - arn:aws:lambda:eu-south-1:344740472567:layer:stepfunctionLambdaLayer:2
      Runtime: python3.10
      Environment:
        Variables:
          STACK_NAME:
            Ref: AWS::StackName
      Timeout: 300
    DependsOn: LambdaRole
  LambdaApprovalFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/9ee3ce93b70602179102ecd76feb9fab
      Description: Lambda function that callback to AWS Step Functions
      FunctionName: LambdaApprovalFunction
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
        - LambdaApiGatewayIAMRole
        - Arn
      Runtime: python3.10
    DependsOn: LambdaApiGatewayIAMRole
  SendEmail:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.sendEmail
      Role:
        Fn::GetAtt:
        - LambdaSendEmailExecutionRole
        - Arn
      Runtime: python3.10
      FunctionName: sendEmail
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/615f26060976ee059928572ee89d3840
      Timeout: 25
      Environment:
        Variables:
          SNS_TOPIC_ARN:
            Ref: SNSHumanApprovalEmailTopic
    DependsOn: LambdaSendEmailExecutionRole
  SendPullRequestEmail:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.sendPullRequestEmail
      Role:
        Fn::GetAtt:
        - LambdaSendEmailExecutionRole
        - Arn
      Runtime: python3.10
      FunctionName: sendPullRequestEmail
      Code:
        S3Bucket: demo-bucket-cloudformation
        S3Key: lambdacode/27f12c97743a08810ba1651da04ce30f
      Timeout: 25
      Environment:
        Variables:
          SNS_TOPIC_ARN:
            Ref: SNSHumanApprovalEmailTopic
          REPOSITORY_NAME:
            Ref: RepositoryName
    DependsOn: LambdaSendEmailExecutionRole
  LambdaApiGatewayInvoke:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
        - LambdaApprovalFunction
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ExecutionApi}/*
  LambdaApiGatewayIAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Action:
          - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
            - lambda.amazonaws.com
      Policies:
      - PolicyName: CloudWatchLogsPolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource:
              Fn::Sub: arn:${AWS::Partition}:logs:*:*:*
      - PolicyName: StepFunctionsPolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - states:SendTaskFailure
            - states:SendTaskSuccess
            Resource: '*'
  LambdaStateMachineExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: states.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: InvokeCallbackLambda
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - lambda:InvokeFunction
            Resource:
            - Fn::Sub: ${SendEmail.Arn}
  LambdaSendEmailExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: CloudWatchLogsPolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource:
              Fn::Sub: arn:${AWS::Partition}:logs:*:*:*
      - PolicyName: SNSSendEmailPolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - SNS:Publish
            Resource:
            - Fn::Sub: ${SNSHumanApprovalEmailTopic}
      - PolicyName: S3FullAccessPolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - s3:*
            - codecommit:GetRepository
            - codecommit:GetBranch
            - codecommit:GetCommit
            Resource:
            - arn:aws:s3:::*
            - Fn::Sub: arn:aws:codecommit:${AWS::Region}:${AWS::AccountId}:${RepositoryName}
  FeedbackStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: FeedbackStateMachine
      DefinitionString:
        Fn::Sub: "{\n  \"Comment\": \"State machine to handle test generation with\
          \ feedback\",\n  \"StartAt\": \"CreateReport\",\n  \"States\": {\n    \"\
          CreateReport\":\n      {\n        \"Type\": \"Task\",\n        \"Resource\"\
          : \"arn:aws:states:::lambda:invoke\",\n        \"Parameters\":\n       \
          \   {\n            \"FunctionName\": \"arn:aws:lambda:eu-south-1:344740472567:function:createReport\"\
          ,\n            \"Payload\": { \"bucketname.$\": \"$.bucketname\", \"key.$\"\
          : \"$.key\", \"branch.$\": \"$.branch\" }\n          },\n        \"ResultSelector\"\
          : { \"Payload.$\": \"$.Payload\" },\n        \"ResultPath\": \"$.taskResult\"\
          ,\n        \"Next\": \"BuildResultChoice\"\n      },\n    \"BuildResultChoice\"\
          :\n      {\n        \"Type\": \"Choice\",\n        \"Choices\":\n      \
          \    [\n            {\n              \"Variable\": \"$.buildResult\",\n\
          \              \"StringEquals\": \"SUCCEEDED\",\n              \"Next\"\
          : \"HandleReport\"\n            },\n            {\n              \"Variable\"\
          : \"$.buildResult\",\n              \"StringEquals\": \"FAILED\",\n    \
          \          \"Next\": \"SendEmail\"\n            }\n          ],\n      \
          \  \"Default\": \"UnknownState\"\n      },\n    \"HandleReport\":\n    \
          \  {\n        \"Type\": \"Task\",\n        \"Resource\": \"arn:aws:states:::lambda:invoke\"\
          ,\n        \"Parameters\":\n          {\n            \"Payload.$\": \"$\"\
          ,\n            \"FunctionName\": \"arn:aws:lambda:eu-south-1:344740472567:function:handleReport\"\
          \n          },\n        \"ResultSelector\": { \"Payload.$\": \"$.Payload\"\
          \ },\n        \"ResultPath\": \"$.taskResult\",\n        \"Retry\":\n  \
          \        [\n            {\n              \"ErrorEquals\":\n            \
          \    [\n                  \"Lambda.ServiceException\",\n               \
          \   \"Lambda.AWSLambdaException\",\n                  \"Lambda.SdkClientException\"\
          ,\n                  \"Lambda.TooManyRequestsException\"\n             \
          \   ],\n              \"IntervalSeconds\": 1,\n              \"MaxAttempts\"\
          : 3,\n              \"BackoffRate\": 2,\n              \"JitterStrategy\"\
          : \"FULL\"\n            }\n          ],\n        \"Next\": \"StartBuild\"\
          \n      },\n    \"StartBuild\": {\n        \"Type\": \"Task\",\n       \
          \ \"Resource\": \"arn:aws:states:::codebuild:startBuild.sync\",\n      \
          \  \"Parameters\": {\n          \"ProjectName\": \"FeedbackBuildProject\"\
          ,\n          \"SourceVersion.$\": \"$.taskResult.Payload.body.branch\"\n\
          \        },\n        \"ResultPath\": \"$.taskResult\",\n        \"Next\"\
          : \"Patch\",\n        \"Catch\": [\n          {\n            \"ErrorEquals\"\
          : [\"States.TaskFailed\"],\n            \"ResultPath\": \"$.taskResult\"\
          ,\n            \"Next\": \"ParseCause\"\n          }\n        ]\n      },\n\
          \      \"ParseCause\": {\n          \"Type\": \"Pass\",\n          \"Parameters\"\
          : {\n            \"bucketname.$\": \"$.bucketname\",\n            \"key.$\"\
          : \"$.key\",\n            \"buildResult.$\": \"$.buildResult\",\n      \
          \      \"Cause.$\": \"States.StringToJson($.taskResult.Cause)\"\n      \
          \    },\n          \"ResultPath\": \"$.parsedCause\",\n          \"Next\"\
          : \"ExtractSourceVersion\"\n        },\n        \"ExtractSourceVersion\"\
          : {\n          \"Type\": \"Pass\",\n          \"Parameters\": {\n      \
          \      \"branch.$\": \"$.parsedCause.Cause.Build.SourceVersion\"\n     \
          \     },\n          \"ResultPath\": \"$.branch\",\n          \"Next\": \"\
          SetFailedResult\"\n        },\n      \"SetFailedResult\": {\n        \"\
          Type\": \"Pass\",\n        \"Parameters\": {\n          \"bucketname.$\"\
          : \"$.bucketname\",\n          \"key.$\": \"$.key\",\n          \"buildResult\"\
          : \"FAILED\",\n          \"branch.$\": \"$.branch.branch\"\n        },\n\
          \        \"ResultPath\": \"$\",\n        \"Next\": \"FinalBuild\"\n    \
          \  },\n      \"Patch\": {\n        \"Type\": \"Pass\",\n        \"Parameters\"\
          : {\n          \"bucketname.$\": \"$.bucketname\",\n          \"key.$\"\
          : \"$.key\",\n          \"buildResult.$\": \"$.taskResult.Build.BuildStatus\"\
          ,\n          \"branch.$\": \"$.taskResult.Build.SourceVersion\"\n      \
          \  },\n        \"ResultPath\": \"$\",\n        \"Next\": \"FinalBuild\"\n\
          \      },\n      \"FinalBuild\": {\n        \"Type\": \"Choice\",\n    \
          \      \"Choices\":\n            [\n              {\n                \"\
          Variable\": \"$.buildResult\",\n                \"StringEquals\": \"SUCCEEDED\"\
          ,\n                \"Next\": \"SendPullRequestEmail\"\n              },\n\
          \              {\n                \"Variable\": \"$.buildResult\",\n   \
          \             \"StringEquals\": \"FAILED\",\n                \"Next\": \"\
          CreateReport\"\n              }\n            ],\n          \"Default\":\
          \ \"UnknownState\"\n      },\n      \"SendPullRequestEmail\":\n      {\n\
          \        \"Type\": \"Task\",\n        \"Resource\": \"arn:${AWS::Partition}:states:::lambda:invoke.waitForTaskToken\"\
          ,\n        \"Parameters\":\n          {\n            \"Payload\":\n    \
          \          {\n                \"ExecutionContext.$\": \"$$\",\n        \
          \        \"APIGatewayEndpoint\": \"https://${ExecutionApi}.execute-api.${AWS::Region}.amazonaws.com/states\"\
          ,\n                \"branch.$\": \"$.branch\"\n              },\n      \
          \      \"FunctionName\": \"arn:aws:lambda:eu-south-1:344740472567:function:sendPullRequestEmail\"\
          \n          },\n        \"ResultPath\": \"$.mailInfo\",\n        \"Retry\"\
          :\n          [\n            {\n              \"ErrorEquals\":\n        \
          \        [\n                  \"Lambda.ServiceException\",\n           \
          \       \"Lambda.AWSLambdaException\",\n                  \"Lambda.SdkClientException\"\
          ,\n                  \"Lambda.TooManyRequestsException\"\n             \
          \   ],\n              \"IntervalSeconds\": 1,\n              \"MaxAttempts\"\
          : 3,\n              \"BackoffRate\": 2,\n              \"JitterStrategy\"\
          : \"FULL\"\n            }\n          ],\n        \"Next\": \"ApprovalPullRequest\"\
          \n      },\n      \"ApprovalPullRequest\":\n      {\n        \"Type\": \"\
          Choice\",\n        \"Choices\":\n          [\n            {\n          \
          \    \"Variable\": \"$.mailInfo.Status\",\n              \"StringEquals\"\
          : \"Approved!\",\n              \"Next\": \"CreatePullRequest\"\n      \
          \      },\n            {\n              \"Variable\": \"$.mailInfo.Status\"\
          ,\n              \"StringEquals\": \"Rejected!\",\n              \"Next\"\
          : \"FailState\"\n            }\n          ]\n      },\n      \"CreatePullRequest\"\
          :\n      {\n        \"Type\": \"Task\",\n        \"Resource\": \"arn:aws:states:::lambda:invoke\"\
          ,\n        \"Parameters\":\n          {\n            \"FunctionName\": \"\
          arn:aws:lambda:eu-south-1:344740472567:function:createPullRequest\",\n \
          \           \"Payload\": { \"branch.$\": \"$.branch\" }\n          },\n\
          \        \"ResultPath\": \"$.taskResult\",\n        \"Retry\":\n       \
          \   [\n            {\n              \"ErrorEquals\":\n                [\n\
          \                  \"Lambda.ServiceException\",\n                  \"Lambda.AWSLambdaException\"\
          ,\n                  \"Lambda.SdkClientException\",\n                  \"\
          Lambda.TooManyRequestsException\"\n                ],\n              \"\
          IntervalSeconds\": 1,\n              \"MaxAttempts\": 3,\n             \
          \ \"BackoffRate\": 2,\n              \"JitterStrategy\": \"FULL\"\n    \
          \        }\n          ],\n        \"Next\": \"WaitForMerge\"\n      },\n\
          \      \"WaitForMerge\": {\n        \"Type\": \"Wait\",\n        \"Seconds\"\
          : 30,\n        \"Next\": \"CheckPullRequest\"\n      },\n      \"CheckPullRequest\"\
          :\n      {\n        \"Type\": \"Task\",\n        \"Resource\": \"arn:aws:states:::lambda:invoke\"\
          ,\n        \"Parameters\":\n          {\n            \"FunctionName\": \"\
          arn:aws:lambda:eu-south-1:344740472567:function:checkPullRequest\",\n  \
          \          \"Payload\": {\n              \"pullRequestId.$\": \"$.taskResult.Payload.pullRequestId\"\
          \n            }\n          },\n        \"ResultPath\": \"$.prCheckResult\"\
          ,\n        \"Retry\":\n          [\n            {\n              \"ErrorEquals\"\
          :\n                [\n                  \"Lambda.ServiceException\",\n \
          \                 \"Lambda.AWSLambdaException\",\n                  \"Lambda.SdkClientException\"\
          ,\n                  \"Lambda.TooManyRequestsException\"\n             \
          \   ],\n              \"IntervalSeconds\": 1,\n              \"MaxAttempts\"\
          : 3,\n              \"BackoffRate\": 2,\n              \"JitterStrategy\"\
          : \"FULL\"\n            }\n          ],\n        \"Next\": \"IsPRMerged\"\
          \n      },\n      \"IsPRMerged\": {\n        \"Type\": \"Choice\",\n   \
          \     \"Choices\": [\n          {\n            \"Variable\": \"$.prCheckResult.Payload.result\"\
          ,\n            \"StringEquals\": \"Merged\",\n            \"Next\": \"StartFinalBuild\"\
          \n          },\n          {\n            \"Variable\": \"$.prCheckResult.Payload.result\"\
          ,\n            \"StringEquals\": \"NotMerged\",\n            \"Next\": \"\
          WaitForMerge\"\n          }\n        ],\n        \"Default\": \"FailState\"\
          \n      },\n      \"StartFinalBuild\": {\n        \"Type\": \"Task\",\n\
          \        \"Resource\": \"arn:aws:states:::codebuild:startBuild.sync\",\n\
          \        \"Parameters\": {\n          \"ProjectName\": \"FinalRevisionBuildProject\"\
          ,\n          \"SourceVersion\": \"refs/heads/master\"\n        },\n    \
          \    \"Next\": \"AdaptOutput\",\n        \"Catch\": [\n          {\n   \
          \         \"ErrorEquals\": [\"States.TaskFailed\"],\n            \"ResultPath\"\
          : \"$.taskResult\",\n            \"Next\": \"FailState\"\n          }\n\
          \        ]\n      },\n\n    \"AdaptOutput\": {\n        \"Type\": \"Task\"\
          ,\n        \"Resource\": \"arn:aws:states:::lambda:invoke\",\n        \"\
          Parameters\":\n          {\n            \"FunctionName\": \"arn:aws:lambda:eu-south-1:344740472567:function:adaptOutput\"\
          \n          },\n        \"Next\": \"Ending\"\n    },\n    \"SendEmail\"\
          :\n      {\n        \"Type\": \"Task\",\n        \"Resource\": \"arn:${AWS::Partition}:states:::lambda:invoke.waitForTaskToken\"\
          ,\n        \"Parameters\":\n          {\n            \"Payload\":\n    \
          \          {\n                \"ExecutionContext.$\": \"$$\",\n        \
          \        \"APIGatewayEndpoint\": \"https://${ExecutionApi}.execute-api.${AWS::Region}.amazonaws.com/states\"\
          ,\n                \"Report.$\": \"$.taskResult.Payload.body\"\n       \
          \       },\n            \"FunctionName\": \"arn:aws:lambda:eu-south-1:344740472567:function:sendEmail\"\
          \n          },\n        \"ResultPath\": \"$.mailInfo\",\n        \"Retry\"\
          :\n          [\n            {\n              \"ErrorEquals\":\n        \
          \        [\n                  \"Lambda.ServiceException\",\n           \
          \       \"Lambda.AWSLambdaException\",\n                  \"Lambda.SdkClientException\"\
          ,\n                  \"Lambda.TooManyRequestsException\"\n             \
          \   ],\n              \"IntervalSeconds\": 1,\n              \"MaxAttempts\"\
          : 3,\n              \"BackoffRate\": 2,\n              \"JitterStrategy\"\
          : \"FULL\"\n            }\n          ],\n        \"Next\": \"ManualApprovalChoiceState\"\
          \n      },\n    \"ManualApprovalChoiceState\":\n      {\n        \"Type\"\
          : \"Choice\",\n        \"Choices\":\n          [\n            {\n      \
          \        \"Variable\": \"$.mailInfo.Status\",\n              \"StringEquals\"\
          : \"Approved!\",\n              \"Next\": \"HandleReport\"\n           \
          \ },\n            {\n              \"Variable\": \"$.mailInfo.Status\",\n\
          \              \"StringEquals\": \"Rejected!\",\n              \"Next\"\
          : \"FailState\"\n            },\n            {\n              \"Variable\"\
          : \"$.mailInfo.Status\",\n              \"StringEquals\": \"Manual!\",\n\
          \              \"Next\": \"FormatOutputState\"\n            }\n        \
          \  ]\n      },\n      \"FormatOutputState\": {\n        \"Type\": \"Pass\"\
          ,\n        \"Parameters\": {\n          \"bucketname.$\": \"$.bucketname\"\
          ,\n          \"key.$\": \"$.key\",\n          \"buildResult.$\": \"$.buildResult\"\
          ,\n          \"branch.$\": \"$.branch\",\n          \"taskResult\": {\n\
          \            \"Payload\": {\n              \"statusCode\": 200,\n      \
          \        \"body\": {\n                \"message\": \"Manual approval\",\n\
          \                \"branch.$\": \"$.branch\"\n              }\n         \
          \   }\n          }\n        },\n        \"ResultPath\": \"$\",\n       \
          \ \"Next\": \"StartBuild\"\n    },\n    \"Ending\": { \n      \"Type\":\
          \ \"Pass\", \n      \"OutputPath\": \"$.Payload\",\n      \"End\": true\n\
          \    },\n    \"UnknownState\":\n      {\n        \"Type\": \"Fail\",\n \
          \       \"Error\": \"UnknownBuildStatus\",\n        \"Cause\": \"The build\
          \ returned an unknown status.\"\n      },\n    \"FailState\":\n      {\n\
          \        \"Type\": \"Fail\",\n        \"Error\": \"Pipeline failed\",\n\
          \        \"Cause\": \"The pipeline failed due to user's choice\"\n     \
          \ }\n  }\n}\n"
      RoleArn:
        Fn::GetAtt:
        - StepFunctionRole
        - Arn
  StepFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - states.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonS3ObjectLambdaExecutionRolePolicy
      - arn:aws:iam::aws:policy/AWSCodeBuildAdminAccess
      - arn:aws:iam::aws:policy/AWSCodeCommitFullAccess
      - arn:aws:iam::aws:policy/AWSLambda_FullAccess
      - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
      - arn:aws:iam::aws:policy/AWSLambdaExecute
      - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
  ExecutionApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: Human approval endpoint
      Description: HTTP Endpoint backed by API Gateway and Lambda
      FailOnWarnings: true
  ExecutionMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: GET
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaApprovalFunction.Arn}/invocations
        IntegrationResponses:
        - StatusCode: 302
          ResponseParameters:
            method.response.header.Location: integration.response.body.headers.Location
        RequestTemplates:
          application/json: "{\n  \"body\" : $input.json('$'),\n  \"headers\": {\n\
            \    #foreach($header in $input.params().header.keySet())\n    \"$header\"\
            : \"$util.escapeJavaScript($input.params().header.get($header))\" #if($foreach.hasNext),#end\n\
            \n    #end\n  },\n  \"method\": \"$context.httpMethod\",\n  \"params\"\
            : {\n    #foreach($param in $input.params().path.keySet())\n    \"$param\"\
            : \"$util.escapeJavaScript($input.params().path.get($param))\" #if($foreach.hasNext),#end\n\
            \n    #end\n  },\n  \"query\": {\n    #foreach($queryParam in $input.params().querystring.keySet())\n\
            \    \"$queryParam\": \"$util.escapeJavaScript($input.params().querystring.get($queryParam))\"\
            \ #if($foreach.hasNext),#end\n\n    #end\n  }  \n}\n"
      ResourceId:
        Ref: ExecutionResource
      RestApiId:
        Ref: ExecutionApi
      MethodResponses:
      - StatusCode: 302
        ResponseParameters:
          method.response.header.Location: true
  ExecutionResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId:
        Ref: ExecutionApi
      ParentId:
        Fn::GetAtt:
        - ExecutionApi
        - RootResourceId
      PathPart: execution
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
    - ExecutionMethod
    Properties:
      RestApiId:
        Ref: ExecutionApi
      StageName: DevStage
  ApiGatewayAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn:
        Fn::GetAtt:
        - ApiGatewayCloudWatchLogsRole
        - Arn
  ApiGatewayCloudWatchLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - apigateway.amazonaws.com
          Action:
          - sts:AssumeRole
      Policies:
      - PolicyName: ApiGatewayLogsPolicy
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource:
              Fn::Sub: arn:${AWS::Partition}:logs:*:*:*
  ExecutionApiStage:
    DependsOn:
    - ApiGatewayAccount
    Type: AWS::ApiGateway::Stage
    Properties:
      DeploymentId:
        Ref: ApiDeployment
      MethodSettings:
      - DataTraceEnabled: true
        HttpMethod: '*'
        LoggingLevel: INFO
        ResourcePath: /*
      RestApiId:
        Ref: ExecutionApi
      StageName: states
  SNSHumanApprovalEmailTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
      - Endpoint:
          Fn::Sub: ${Email}
        Protocol: email
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      InstanceTenancy: default
  Subnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: VPC
      AvailabilityZone:
        Fn::Select:
        - 0
        - Fn::GetAZs: ''
      CidrBlock:
        Fn::Sub: 10.0.0.0/20
      MapPublicIpOnLaunch: true
  InternetGateway:
    Type: AWS::EC2::InternetGateway
  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId:
        Ref: InternetGateway
      VpcId:
        Ref: VPC
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: VPC
  RouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: Subnet1
      RouteTableId:
        Ref: RouteTable
  InternetRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: RouteTable
      DestinationCidrBlock: 0.0.0.0/0
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
          Action: sts:AssumeRole
        - Effect: Allow
          Principal:
            AWS:
              Fn::GetAtt:
              - CodePipelineServiceRole
              - Arn
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      - arn:aws:iam::aws:policy/AmazonS3FullAccess
      Policies:
      - PolicyName: CustomEcsTaskExecutionPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - logs:*
            Resource: '*'
          - Effect: Allow
            Action:
            - ecr:*
            Resource: '*'
          - Effect: Allow
            Action:
            - s3:*
            Resource: '*'
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: spring-boot-app
  CloudWatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: apis
      RetentionInDays: 1
  ContainerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId:
        Ref: VPC
      GroupDescription: for ECS containers
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        IpProtocol: -1
  Task:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: spring-boot-app
      Cpu: 256
      Memory: 512
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
      ExecutionRoleArn:
        Fn::GetAtt:
        - ECSTaskExecutionRole
        - Arn
      ContainerDefinitions:
      - Name: backend-service
        Image: 344740472567.dkr.ecr.eu-south-1.amazonaws.com/spring-boot-app
        PortMappings:
        - ContainerPort: 8080
        Environment:
        - Name: DB_HOST
          Value: postgres-db
        - Name: DB_PORT
          Value: '5432'
        - Name: DB_USER
          Value: myuser
        - Name: DB_PASSWORD
          Value: mypassword
        - Name: DB_NAME
          Value: demo_db
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-region:
              Ref: AWS::Region
            awslogs-group:
              Ref: CloudWatchLogsGroup
            awslogs-stream-prefix: ecs
      - Name: postgres-db
        Image: postgres:latest
        PortMappings:
        - ContainerPort: 5432
        Environment:
        - Name: POSTGRES_PASSWORD
          Value: mypassword
        - Name: POSTGRES_USER
          Value: myuser
        - Name: POSTGRES_DB
          Value: demo_db
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-region:
              Ref: AWS::Region
            awslogs-group:
              Ref: CloudWatchLogsGroup
            awslogs-stream-prefix: postgres
  Service:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: backend-service
      TaskDefinition:
        Ref: Task
      Cluster:
        Ref: ECSCluster
      LaunchType: FARGATE
      DesiredCount: 1
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 70
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          Subnets:
          - Ref: Subnet1
          SecurityGroups:
          - Ref: ContainerSecurityGroup
